TEST_NAME=num

# Get configuration information
. ../../_config/config.sh

sed "s/TEST_NAME/$TEST_NAME/g" ../../_config/template.cabal > "$TEST_NAME".cabal

# Set up clean logs directory
rm -rf logs/
mkdir logs

# Use pre-existing build directory to avoid rechecking stdlib modules
ln -sf ../../_build _build

# Compile the Agda module and build the generated code
$1 --compile-dir=_build -c --ghc-dont-call-ghc Main.agda > logs/agda-build
cabal build "$TEST_NAME" --with-compiler "$GHC_EXEC" > logs/cabal-build

# Run the test
cabal exec -v0 "$TEST_NAME" --with-compiler "$GHC_EXEC" > output

# Clean up after ourselves
rm "$TEST_NAME".cabal
rm -R dist-newstyle
rm -R _build/MAlonzo/Code/